name: Secure TradingView Flatpak Build

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    env:
      EXPECTED_TV_FPR: ${{ secrets.TRADINGVIEW_GPG_FINGERPRINT }}

    steps:
      - uses: actions/checkout@v4

      # -----------------------------------------
      # Install dependencies
      # -----------------------------------------
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y flatpak flatpak-builder gnupg dpkg-dev wget rsync

      # -----------------------------------------
      # Add Flathub (user remote)
      # -----------------------------------------
      - name: Add Flathub
        run: |
          flatpak remote-add --if-not-exists --user flathub \
            https://flathub.org/repo/flathub.flatpakrepo

      # -----------------------------------------
      # Detect latest runtime properly
      # -----------------------------------------
      - name: Detect latest Freedesktop runtime
        run: |
          LATEST_VERSION=$(flatpak remote-ls --user flathub \
            --runtime \
            --columns=ref \
            | grep '^org.freedesktop.Sdk/x86_64/' \
            | cut -d/ -f3 \
            | sort -V \
            | tail -n1)

          if [ -z "$LATEST_VERSION" ]; then
            echo "Failed to detect runtime version"
            flatpak remote-ls --user flathub --runtime
            exit 1
          fi

          echo "Latest runtime version: $LATEST_VERSION"

          flatpak install -y --user flathub org.freedesktop.Sdk//$LATEST_VERSION
          flatpak install -y --user flathub org.freedesktop.Platform//$LATEST_VERSION

          echo "LATEST_VERSION=$LATEST_VERSION" >> $GITHUB_ENV

      # -----------------------------------------
      # Update manifest runtime-version
      # -----------------------------------------
      - name: Update manifest runtime-version
        run: |
          sed -i "s/runtime-version:.*/runtime-version: \"$LATEST_VERSION\"/" \
            flatpak/com.tradingview.TradingView.yml

      # -----------------------------------------
      # Build Flatpak
      # -----------------------------------------
      - name: Build Flatpak
        run: |
          flatpak-builder \
            --user \
            --install-deps-from=flathub \
            --force-clean \
            --repo=repo \
            build-dir \
            flatpak/com.tradingview.TradingView.yml

      # -----------------------------------------
      # Import signing key
      # -----------------------------------------
      - name: Import GPG signing key
        run: echo "${{ secrets.FLATPAK_GPG_KEY }}" | gpg --batch --import

      - name: Sign repo
        run: flatpak build-sign repo --gpg-sign=${{ secrets.FLATPAK_GPG_KEY_ID }}

      # -----------------------------------------
      # Publish to gh-pages
      # -----------------------------------------
      - name: Publish to gh-pages
        run: |
          git fetch origin gh-pages || true
          git checkout gh-pages || git checkout --orphan gh-pages
          rsync -a --delete repo/ .
          git add .
          git commit -m "Update Flatpak build" || true
          git push origin gh-pages
