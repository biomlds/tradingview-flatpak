name: Secure TradingView Flatpak Build

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    env:
      EXPECTED_TV_FPR: ${{ secrets.TRADINGVIEW_GPG_FINGERPRINT }}
      FLATPAK_GPG_KEY: ${{ secrets.FLATPAK_GPG_KEY }}
      FLATPAK_GPG_KEY_ID: ${{ secrets.FLATPAK_GPG_KEY_ID }}

    steps:
      - uses: actions/checkout@v4

      # Install dependencies
      - name: Install dependencies
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            flatpak flatpak-builder ostree \
            gnupg dpkg-dev wget rsync curl ca-certificates

      # Download & verify TradingView GPG key
      - name: Download TradingView key
        run: curl -fsSL -o tradingview.gpg https://tvd-packages.tradingview.com/keyring.gpg

      - name: Verify fingerprint
        run: |
          set -euxo pipefail
          gpg --batch --import tradingview.gpg
          FPR=$(gpg --with-colons --show-keys tradingview.gpg | awk -F: '/^fpr:/ {print $10; exit}')
          echo "Fingerprint: $FPR"
          test "$FPR" = "$EXPECTED_TV_FPR"

      - name: Install verified key
        run: |
          sudo install -m 0644 tradingview.gpg \
            /usr/share/keyrings/tradingview-desktop-archive-keyring.gpg

      # Add official repo
      - name: Add TradingView repo
        run: |
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/tradingview-desktop-archive-keyring.gpg] \
          https://tvd-packages.tradingview.com/ubuntu/stable jammy multiverse" \
          | sudo tee /etc/apt/sources.list.d/tradingview.list

      - name: Update apt
        run: sudo apt-get update

      # Get latest version
      - name: Get candidate version
        id: version
        run: |
          VERSION=$(apt-cache policy tradingview | awk '/Candidate:/ {print $2}')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      # Download verified package
      - name: Download .deb
        run: |
          apt download tradingview
          mkdir -p flatpak
          mv tradingview_*_amd64.deb flatpak/tradingview.deb
          ls -lh flatpak/tradingview.deb

      # Add Flathub
      - name: Add Flathub
        run: flatpak remote-add --if-not-exists --user flathub https://dl.flathub.org/repo/flathub.flatpakrepo

      # Install runtime
      - name: Install SDK & Platform
        run: |
          flatpak install -y --user flathub org.freedesktop.Sdk//25.08
          flatpak install -y --user flathub org.freedesktop.Platform//25.08

      # Build Flatpak
      - name: Build
        run: |
          flatpak-builder \
            --user \
            --install-deps-from=flathub \
            --force-clean \
            --repo=repo \
            build-dir \
            flatpak/com.tradingview.tradingview.yaml

          ostree --repo=repo summary -u
          du -sh build-dir/files

      # Import signing key
      - name: Import GPG key
        if: env.FLATPAK_GPG_KEY != ''
        run: |
          printf '%s' "$FLATPAK_GPG_KEY" | gpg --batch --import

      # Sign repo
      - name: Sign repo
        if: env.FLATPAK_GPG_KEY_ID != ''
        run: |
          flatpak build-sign repo --gpg-sign="$FLATPAK_GPG_KEY_ID"

      # Publish to gh-pages
      - name: Publish
        run: |
          set -euxo pipefail
          git fetch origin

          PUBLISH_DIR="_site"
          rm -rf "$PUBLISH_DIR"

          if git ls-remote --exit-code --heads origin gh-pages >/dev/null 2>&1; then
            git worktree add -B gh-pages "$PUBLISH_DIR" origin/gh-pages
          else
            git worktree add -B gh-pages "$PUBLISH_DIR"
          fi

          rsync -a --delete --exclude='.git*' repo/ "$PUBLISH_DIR"/
          touch "$PUBLISH_DIR"/.nojekyll

          cd "$PUBLISH_DIR"
          git add -A
          git commit -m "Publish TradingView $(date -u +%Y-%m-%dT%H:%M:%SZ)" || true
          git push --force origin gh-pages