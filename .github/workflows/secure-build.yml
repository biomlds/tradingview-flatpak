name: Secure TradingView Flatpak Build

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    env:
      EXPECTED_TV_FPR: ${{ secrets.TRADINGVIEW_GPG_FINGERPRINT }}
      FLATPAK_GPG_KEY: ${{ secrets.FLATPAK_GPG_KEY }}
      FLATPAK_GPG_KEY_ID: ${{ secrets.FLATPAK_GPG_KEY_ID }}

    steps:
      - uses: actions/checkout@v4

      # Install dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder ostree gnupg dpkg-dev wget rsync curl ca-certificates

      # Verify TradingView GPG key
      - name: Download TradingView GPG
        run: curl -fsSL -o tradingview.gpg https://tvd-packages.tradingview.com/keyring.gpg

      - name: Verify GPG fingerprint
        run: |
          gpg --batch --import tradingview.gpg
          FPR=$(gpg --with-colons --show-keys tradingview.gpg | awk -F: '/^fpr:/ {print $10; exit}')
          if [ "$FPR" != "$EXPECTED_TV_FPR" ]; then
            echo "Fingerprint mismatch! Expected $EXPECTED_TV_FPR, got $FPR"
            exit 1
          fi
          sudo install -o root -g root -m 0644 tradingview.gpg \
            /usr/share/keyrings/tradingview-desktop-archive-keyring.gpg

      # Add official APT repo and update
      - name: Add TradingView APT repo
        run: |
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/tradingview-desktop-archive-keyring.gpg] https://tvd-packages.tradingview.com/ubuntu/stable jammy multiverse" \
          | sudo tee /etc/apt/sources.list.d/tradingview.list
          sudo apt-get update

      # Get latest version
      - name: Get latest TradingView version
        id: version
        run: |
          VERSION=$(apt-cache policy tradingview | awk '/Candidate:/ {print $2}')
          if [ -z "$VERSION" ] || [ "$VERSION" = "(none)" ]; then exit 1; fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      # Download official .deb
      - name: Download TradingView .deb
        run: |
          apt download tradingview
          mkdir -p flatpak
          mv tradingview_*_amd64.deb flatpak/tradingview.deb

      # Add Flathub
      - name: Add Flathub
        run: flatpak remote-add --if-not-exists --user flathub https://dl.flathub.org/repo/flathub.flatpakrepo
            
      # Install runtime, SDK, and Electron BaseApp
      - name: Install Flatpak dependencies
        run: |
          flatpak install -y --user flathub org.freedesktop.Sdk//25.08
          flatpak install -y --user flathub org.freedesktop.Platform//25.08
          flatpak install -y --user flathub org.electronjs.Electron2.BaseApp//25.08

      # Build Flatpak
      - name: Build Flatpak
        run: |
          mkdir -p repo
          flatpak-builder \
            --user \
            --install-deps-from=flathub \
            --force-clean \
            --disable-rofiles-fuse \
            --repo=repo \
            build-dir \
            flatpak/com.tradingview.tradingview.yaml

      # Import signing key
      - name: Import GPG key
        if: env.FLATPAK_GPG_KEY != ''
        run: |
          printf '%s' "$FLATPAK_GPG_KEY" | gpg --batch --import

      # Sign repo
      - name: Sign repo
        if: env.FLATPAK_GPG_KEY_ID != ''
        run: |
          flatpak build-sign repo --gpg-sign="$FLATPAK_GPG_KEY_ID"

      # Publish to gh-pages
            # Publish to gh-pages
      - name: Publish to gh-pages (via worktree)
        run: |
          set -euxo pipefail
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git fetch origin

          PUBLISH_DIR="_site"
          rm -rf "$PUBLISH_DIR"

          if git ls-remote --exit-code --heads origin gh-pages >/dev/null 2>&1; then
            git worktree add --track -B gh-pages "$PUBLISH_DIR" origin/gh-pages
          else
            git worktree add -B gh-pages "$PUBLISH_DIR"
            (cd "$PUBLISH_DIR" && rm -rf ./* .gitignore 2>/dev/null || true)
          fi

          if [ ! -d "repo" ]; then
            echo "ERROR: The build 'repo' directory does not exist."
            exit 1
          fi

          # Sync Flatpak repo
          rsync -a --delete \
            --exclude '.git' \
            --exclude '.git/**' \
            --exclude '.git*' \
            repo/ "$PUBLISH_DIR"/

          # âœ… Copy flatpakrepo file to gh-pages root
          if [ -f "tradingview.flatpakrepo" ]; then
            cp tradingview.flatpakrepo "$PUBLISH_DIR"/
          else
            echo "ERROR: tradingview.flatpakrepo not found in main branch root."
            exit 1
          fi

          touch "$PUBLISH_DIR"/.nojekyll

          cd "$PUBLISH_DIR"
          git add -A
          git -c user.name="github-actions[bot]" \
              -c user.email="41898282+github-actions[bot]@users.noreply.github.com" \
              commit -m "Publish TradingView repo ${GITHUB_SHA::7} ($(date -u +%Y-%m-%dT%H:%M:%SZ))" || echo "No changes to commit"

          git push --force origin gh-pages

          cd "$GITHUB_WORKSPACE"
          git worktree remove -f "$PUBLISH_DIR" || true