name: Secure TradingView Flatpak Build

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    env:
      # https://tvd-packages.tradingview.com/keyring.gpg
      EXPECTED_TV_FPR: ${{ secrets.TRADINGVIEW_GPG_FINGERPRINT }}

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y flatpak flatpak-builder gnupg dpkg-dev

      # -----------------------------------------
      # 1. Verify TradingView GPG fingerprint
      # -----------------------------------------
      - name: Download TradingView key
        run: wget -O tradingview.gpg https://tvd-packages.tradingview.com/keyring.gpg

      - name: Verify fingerprint
        run: |
          FPR=$(gpg --show-keys --with-colons tradingview.gpg | grep fpr | head -n1 | cut -d: -f10)
          echo "Fingerprint: $FPR"
          if [ "$FPR" != "$EXPECTED_TV_FPR" ]; then
            echo "Fingerprint mismatch!"
            exit 1
          fi

      - name: Install verified key
        run: |
          sudo install -o root -g root -m 644 tradingview.gpg \
          /usr/share/keyrings/tradingview-desktop-archive-keyring.gpg

      # -----------------------------------------
      # 2. Add official APT repo
      # -----------------------------------------
      - name: Add TradingView repo
        run: |
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/tradingview-desktop-archive-keyring.gpg] \
          https://tvd-packages.tradingview.com/ubuntu/stable jammy multiverse" \
          | sudo tee /etc/apt/sources.list.d/tradingview.list

      - name: Update apt
        run: sudo apt update

      # -----------------------------------------
      # 3. Detect new version
      # -----------------------------------------
      - name: Get candidate version
        id: version
        run: |
          VERSION=$(apt-cache policy tradingview | grep Candidate | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Check version change
        id: check
        run: |
          if [ -f VERSION ]; then
            CURRENT=$(cat VERSION)
          else
            CURRENT="none"
          fi

          if [ "$CURRENT" = "${{ steps.version.outputs.version }}" ]; then
            echo "update=false" >> $GITHUB_OUTPUT
          else
            echo "${{ steps.version.outputs.version }}" > VERSION
            echo "update=true" >> $GITHUB_OUTPUT
          fi

      - name: Stop if no update
        if: steps.check.outputs.update == 'false'
        run: exit 0

      # -----------------------------------------
      # 4. Download verified package
      # -----------------------------------------
      - name: Download .deb via apt
        run: |
          apt download tradingview
          mv tradingview_*.deb flatpak/tradingview.deb

      # -----------------------------------------
      # 5. Build reproducible Flatpak
      # -----------------------------------------
      - name: Add Flathub
        run: flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Build Flatpak
        run: |
          flatpak-builder build-dir flatpak/com.tradingview.TradingView.yml \
            --force-clean \
            --disable-cache \
            --repo=repo

      # -----------------------------------------
      # 6. Import your signing key
      # -----------------------------------------
      - name: Import GPG signing key
        run: echo "${{ secrets.FLATPAK_GPG_KEY }}" | gpg --batch --import

      - name: Sign repo
        run: flatpak build-sign repo --gpg-sign=${{ secrets.FLATPAK_GPG_KEY_ID }}

      # -----------------------------------------
      # 7. Publish without deleting history
      # -----------------------------------------
      - name: Publish to gh-pages
        run: |
          git fetch origin gh-pages || true
          git checkout gh-pages || git checkout --orphan gh-pages
          rsync -a --delete repo/ .
          git add .
          git commit -m "TradingView ${{ steps.version.outputs.version }}" || true
          git push origin gh-pages